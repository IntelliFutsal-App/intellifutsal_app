version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: intellifutsal_postgres
    restart: always
    ports:
      - "127.0.0.1:5433:5432"
    environment:
      POSTGRES_USER: ${DB_PROD_USERNAME}
      POSTGRES_PASSWORD: ${DB_PROD_PASSWORD}
      POSTGRES_DB: ${DB_PROD_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./intellifutsal_back/init-scripts:/docker-entrypoint-initdb.d
    networks:
      - intellifutsal-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_PROD_USERNAME} -d ${DB_PROD_NAME} -h localhost || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  flask-backend:
    build:
      context: ./intellifutsal_ai_back
      dockerfile: Dockerfile
    container_name: intellifutsal_flask_backend
    restart: always
    environment:
      POSITIONS_MODEL_PATH: ${POSITIONS_MODEL_PATH}
      PHYSICAL_CONDITIONS_MODEL_PATH: ${PHYSICAL_CONDITIONS_MODEL_PATH}
      POSITIONS_SCALER_PATH: ${POSITIONS_SCALER_PATH}
      PHYSICAL_CONDITIONS_SCALER_PATH: ${PHYSICAL_CONDITIONS_SCALER_PATH}
      DEBUG: ${DEBUG}
      HOST: 0.0.0.0
      PORT: 5000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REQUEST_TIMEOUT: 10
      MAX_CONTENT_LENGTH: 1024000
    volumes:
      - ./intellifutsal_ai_back/app:/app/app
      - ./intellifutsal_ai_back/static:/static
      - ./intellifutsal_ai_back/main.py:/app/main.py
      - ./intellifutsal_ai_back/.env:/app/.env
    networks:
      - intellifutsal-network
    depends_on:
      - postgres

  nodejs-backend:
    build:
      context: ./intellifutsal_back
      dockerfile: Dockerfile
    container_name: intellifutsal_nodejs_backend
    restart: always
    ports:
      - "127.0.0.1:${APP_PORT}:3000"
    environment:
      DB_DEV_TYPE: ${DB_DEV_TYPE}
      DB_DEV_HOST: postgres
      DB_DEV_PORT: 5432
      DB_DEV_USERNAME: ${DB_DEV_USERNAME}
      DB_DEV_PASSWORD: ${DB_DEV_PASSWORD}
      DB_DEV_NAME: ${DB_DEV_NAME}

      DB_PROD_TYPE: ${DB_PROD_TYPE}
      DB_PROD_HOST: ${DB_PROD_HOST}
      DB_PROD_PORT: ${DB_PROD_PORT}
      DB_PROD_USERNAME: ${DB_PROD_USERNAME}
      DB_PROD_PASSWORD: ${DB_PROD_PASSWORD}
      DB_PROD_NAME: ${DB_PROD_NAME}

      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}

      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      SENDGRID_FROM_EMAIL: ${SENDGRID_FROM_EMAIL}

      TOKEN_TYPE: ${TOKEN_TYPE}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      APP_PORT: ${APP_PORT}
      NODE_ENV: ${NODE_ENV:-development}
      RUN_MIGRATIONS: "true"

      AI_API_URL: ${AI_API_URL}
      FLASK_BACKEND_URL: http://flask-backend:5000
    volumes:
      - ./intellifutsal_back:/usr/src/app
      - /usr/src/app/node_modules
    networks:
      - intellifutsal-network
    depends_on:
      - postgres
      - flask-backend

  react-frontend:
    build:
      context: ./intellifutsal_front
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL}
    container_name: intellifutsal_react_frontend
    restart: always
    ports:
      - "127.0.0.1:5173:80"
    environment:
      VITE_API_URL: ${VITE_API_URL}
    networks:
      - intellifutsal-network
    depends_on:
      - nodejs-backend

volumes:
  postgres_data:
    driver: local

networks:
  intellifutsal-network:
    driver: bridge
    name: intellifutsal-network